{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto mt-10 bg-white rounded-xl shadow p-6">
  <h2 class="text-xl font-bold mb-4">ğŸ“Š CSVæ•´å½¢ãƒ»æ¤œè¨¼ãƒ„ãƒ¼ãƒ«</h2>

  <form action="/tools/csvtool" method="POST" enctype="multipart/form-data">
    <div class="mb-4">
      <label class="block mb-1">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
      <input type="file" name="csvfile" accept=".csv" required class="w-full">
    </div>
    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
  </form>

  {% if headers %}
  <form action="/tools/csvtool/process" method="POST" id="processForm">
    <div class="mt-6">
      <label class="block font-semibold mb-2">âœ… ã‚ªãƒ—ã‚·ãƒ§ãƒ³:</label>
      <label><input type="checkbox" name="trim" checked> ã‚»ãƒ«ã®å‰å¾Œç©ºç™½ã‚’å‰Šé™¤</label><br>
      <label><input type="checkbox" name="check_missing" checked> æ¬ æãƒã‚§ãƒƒã‚¯</label><br>
      <label><input type="checkbox" name="check_duplicate"> é‡è¤‡è¡Œãƒã‚§ãƒƒã‚¯</label><br>
    </div>

    <div class="mt-4">
      <label class="block font-semibold mb-2">ğŸ”€ ä¸¦ã³é †ã‚’å¤‰æ›´ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆï¼‰:</label>
      <ul id="sortableHeaders" class="flex flex-wrap gap-2 bg-gray-50 p-2 rounded border">
        {% for h in headers %}
          <li class="draggable-header bg-gray-200 px-3 py-1 rounded cursor-move" data-header="{{ h }}">{{ h }}</li>
        {% endfor %}
      </ul>
      <input type="hidden" name="headers_order" id="headersOrder">
    </div>

    <div class="mt-4">
      <label class="block font-semibold mb-2">âœ‚ æŠ½å‡ºã™ã‚‹åˆ—:</label>
      {% for h in headers %}
        <label class="mr-2"><input type="checkbox" name="selected_columns" value="{{ h }}" checked> {{ h }}</label>
      {% endfor %}
    </div>

    <div class="mt-4">
      <label class="block font-semibold mb-1">ğŸ” ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶:</label>
      <input type="text" name="filter" class="w-full border rounded px-2 py-1" placeholder="ä¾‹: å±±ç”°">
    </div>

    <button type="submit" class="bg-blue-600 text-white px-4 py-2 mt-4 rounded hover:bg-blue-700">æ“ä½œã‚’ç¢ºå®š</button>
  </form>

  <div class="mt-6">
    <h3 class="font-semibold mb-2">ğŸ“‹ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€å¤§20è¡Œï¼‰:</h3>
    <div class="overflow-x-auto max-h-80 border rounded">
      <table class="table-auto border-collapse w-full text-sm">
        <thead>
          <tr>
            {% for h in headers %}
              <th class="border px-2 py-1 bg-gray-100">{{ h }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in preview %}
            <tr>
              {% for cell in row %}
                <td class="border px-2 py-1">{{ cell }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if issues %}
    <div class="mt-4 text-red-600">
      <h4 class="font-semibold mb-1">âš  æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ:</h4>
      <ul class="list-disc pl-5 text-sm">
        {% for issue in issues %}
          <li>{{ issue }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <div class="mt-6">
    <a href="{{ url_for('csvtool.download') }}" class="text-blue-600 underline">ğŸ“¥ ä¿®æ­£æ¸ˆã¿CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
  </div>
  {% endif %}
</div>

<style>
  .draggable-header {
    user-select: none;
  }
</style>

<script>
  // ä¸¦ã³é †ã‚’å–å¾—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«åŸ‹ã‚è¾¼ã‚€
  const headersOrderInput = document.getElementById("headersOrder");
  const sortableHeaders = document.getElementById("sortableHeaders");

  let dragSrcEl = null;

  function handleDragStart(e) {
    dragSrcEl = this;
    this.classList.add("opacity-50");
  }

  function handleDragEnd() {
    this.classList.remove("opacity-50");
    updateHeadersOrderInput();
  }

  function handleDragOver(e) {
    e.preventDefault();
    const target = e.target.closest(".draggable-header");
    if (target && target !== dragSrcEl) {
      const rect = target.getBoundingClientRect();
      const next = (e.clientX - rect.left) / rect.width > 0.5;
      sortableHeaders.insertBefore(dragSrcEl, next ? target.nextSibling : target);
    }
  }

  function updateHeadersOrderInput() {
    const order = Array.from(sortableHeaders.children).map(el => el.dataset.header);
    headersOrderInput.value = JSON.stringify(order);
  }

  document.querySelectorAll(".draggable-header").forEach(el => {
    el.setAttribute("draggable", true);
    el.addEventListener("dragstart", handleDragStart);
    el.addEventListener("dragend", handleDragEnd);
  });

  sortableHeaders.addEventListener("dragover", handleDragOver);
  updateHeadersOrderInput(); // åˆæœŸå€¤è¨­å®š
</script>
{% endblock %}
