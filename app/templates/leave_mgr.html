{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='leave_mgr/css/leave_mgr.css') }}">

<div class="max-w-7xl mx-auto mt-6 bg-white rounded-xl shadow-lg p-6">
    <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">📅 有休マネージャー</h2>
    
    <!-- 上部コントロール（幅制限） -->
    <div class="top-controls-container">
        <!-- ユーザー情報表示 -->
        <div class="user-info-box">
            <p class="text-sm">
                ログインID: <span class="font-semibold">{{ user_id }}</span>
                {% if is_admin %}
                <span class="ml-3 badge badge-admin">管理者</span>
                {% endif %}
            </p>
        </div>

        <!-- カレンダー選択 -->
        <div class="calendar-select-container">
            <label class="text-sm font-medium text-gray-700">カレンダー:</label>
            <select id="calendar-select" class="calendar-select form-input">
                <option value="">選択してください</option>
                {% for cal_id in user_calendars %}
                <option value="{{ cal_id }}">
                    {{ calendar_meta.get(cal_id, {}).get('name', cal_id) }}
                </option>
                {% endfor %}
            </select>
            {% if is_admin %}
            <button onclick="showAdminModal()" class="btn btn-danger">
                管理者メニュー
            </button>
            {% endif %}
        </div>
    </div>

    <!-- 月選択コントロール -->
    <div class="mb-6 flex items-center justify-between">
        <button onclick="changeMonth(-1)" class="btn btn-secondary">
            ◀ 前月
        </button>
        
        <div class="flex items-center gap-2">
            <input type="month" id="month-picker" class="form-input" style="width: 200px;">
            <button onclick="goToMonth()" class="btn btn-primary">
                移動
            </button>
        </div>
        
        <button onclick="changeMonth(1)" class="btn btn-secondary">
            次月 ▶
        </button>
    </div>

    <!-- カレンダー表示エリア -->
    <div id="calendar-container" class="mb-6">
        <div class="text-center text-gray-500 py-8">
            カレンダーを選択してください
        </div>
    </div>

    <!-- 休暇登録ボタン -->
    <div class="text-center">
        <button onclick="showLeaveModal()" class="btn btn-success" disabled id="add-leave-btn">
            ➕ 休暇登録
        </button>
    </div>
</div>

<!-- 休暇登録/編集モーダル -->
<div id="leave-modal" class="hidden modal-overlay">
    <div class="modal-content">
        <h3 class="text-lg font-bold mb-4" id="leave-modal-title">休暇登録</h3>
        
        <form id="leave-form">
            <input type="hidden" id="leave-id">
            
            <div class="form-group">
                <label class="form-label">日付 *</label>
                <input type="date" id="leave-date" class="form-input" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">休暇取得者名 *</label>
                <input type="text" id="leave-name" class="form-input" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">休暇種類 *</label>
                <select id="leave-type" class="form-input" required>
                    {% for type_name in leave_types.keys() %}
                    <option value="{{ type_name }}">{{ type_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">代務者（カンマ区切りで複数入力可）</label>
                <input type="text" id="leave-deputies" class="form-input" placeholder="例: 田中, 佐藤">
            </div>
            
            <div class="form-group">
                <label class="form-label">備考</label>
                <textarea id="leave-remarks" class="form-input" rows="2"></textarea>
            </div>
            
            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeLeaveModal()" class="btn btn-outline">
                    キャンセル
                </button>
                <button type="submit" class="btn btn-primary">
                    保存
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 日付詳細モーダル -->
<div id="date-detail-modal" class="hidden modal-overlay">
    <div class="modal-content modal-large">
        <h3 class="text-lg font-bold mb-4" id="date-detail-title">日付詳細</h3>
        
        <div id="date-detail-content" style="max-height: 400px; overflow-y: auto;">
            <!-- 動的に内容を挿入 -->
        </div>
        
        <div class="text-right mt-4">
            <button onclick="closeDateDetailModal()" class="btn btn-outline">
                閉じる
            </button>
        </div>
    </div>
</div>

<!-- 管理者モーダル -->
{% if is_admin %}
<div id="admin-modal" class="hidden modal-overlay">
    <div class="modal-content modal-xlarge">
        <h3 class="text-lg font-bold mb-4 text-red-600">管理者メニュー</h3>
        
        <!-- タブメニュー -->
        <div class="admin-tabs">
            <button onclick="switchAdminTab('calendar')" class="admin-tab active" data-tab="calendar">
                カレンダー作成
            </button>
            <button onclick="switchAdminTab('permission')" class="admin-tab" data-tab="permission">
                権限付与
            </button>
            <button onclick="switchAdminTab('users')" class="admin-tab" data-tab="users">
                ユーザー一覧
            </button>
        </div>
        
        <!-- カレンダー作成タブ -->
        <div id="admin-calendar-tab" class="admin-tab-content active">
            <h4 class="font-semibold mb-3">新規カレンダー作成</h4>
            <div class="form-group">
                <label class="form-label">カレンダーID *</label>
                <input type="text" id="new-calendar-id" class="form-input" placeholder="例: dept_sales" style="max-width: 300px;">
                <p class="text-xs text-gray-500 mt-1">英数字とアンダースコアのみ、最大20文字</p>
            </div>
            <div class="form-group">
                <label class="form-label">カレンダー名</label>
                <input type="text" id="new-calendar-name" class="form-input" placeholder="例: 営業部" style="max-width: 300px;">
            </div>
            <button onclick="createCalendar()" class="btn btn-success">
                作成
            </button>
        </div>
        
        <!-- 権限付与タブ -->
        <div id="admin-permission-tab" class="admin-tab-content">
            <h4 class="font-semibold mb-3">権限付与</h4>
            
            <div class="mb-4 p-3 bg-yellow-50 rounded">
                <h5 class="font-semibold mb-2">カレンダーアクセス権限</h5>
                <div class="flex gap-2" style="max-width: 600px;">
                    <input type="text" id="grant-user-id" class="form-input" placeholder="ユーザーID" style="flex: 1;">
                    <select id="grant-calendar-id" class="form-input" style="width: 200px;">
                        <option value="">カレンダー選択</option>
                        {% for cal_id, cal_info in calendar_meta.items() %}
                        <option value="{{ cal_id }}">{{ cal_info.get('name', cal_id) }}</option>
                        {% endfor %}
                    </select>
                    <button onclick="grantCalendarPermission()" class="btn btn-primary">
                        付与
                    </button>
                </div>
            </div>
            
            <div class="p-3 bg-red-50 rounded">
                <h5 class="font-semibold mb-2 text-red-600">管理者権限</h5>
                <div class="flex gap-2" style="max-width: 400px;">
                    <input type="text" id="grant-admin-id" class="form-input" placeholder="ユーザーID" style="flex: 1;">
                    <button onclick="grantAdminPermission()" class="btn btn-danger">
                        管理者権限付与
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ユーザー一覧タブ -->
        <div id="admin-users-tab" class="admin-tab-content">
            <h4 class="font-semibold mb-3">ユーザー権限一覧</h4>
            <div id="users-list-content" style="max-height: 400px; overflow-y: auto;">
                <p class="text-gray-500">読み込み中...</p>
            </div>
        </div>
        
        <div class="text-right mt-4 border-t pt-4">
            <button onclick="closeAdminModal()" class="btn btn-outline">
                閉じる
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- 確認ダイアログ -->
<div id="confirm-dialog" class="hidden modal-overlay">
    <div class="modal-content">
        <h3 class="text-lg font-bold mb-4">確認</h3>
        <p id="confirm-message" class="mb-4" style="white-space: pre-line;"></p>
        <div class="flex justify-end gap-2">
            <button onclick="closeConfirmDialog()" class="btn btn-outline">
                キャンセル
            </button>
            <button onclick="confirmAction()" class="btn btn-primary">
                続行
            </button>
        </div>
    </div>
</div>

<script>
    // 休暇種類の色定義をJavaScriptに渡す
    window.leaveColors = {{ leave_types | tojson }};
</script>
<script src="{{ url_for('static', filename='leave_mgr/js/leave_mgr.js') }}"></script>
{% endblock %}